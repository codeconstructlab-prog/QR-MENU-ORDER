<!doctype html> 
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Menu — QR Ordering</title>

  <!-- SUPABASE SDK -->

  <style>
    :root{
      --accent:#ff6347;
      --bg:#f6f7f9;
      --card:#ffffff;
      --muted:#666;
      --radius:12px;
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,Segoe UI,Arial; margin:0; background:var(--bg); color:#111;}
    header{
      background:var(--accent); color:#fff; padding:18px 16px; display:flex; gap:12px; align-items:center; justify-content:space-between;
      position:sticky; top:0; z-index:20;
    }
    header h1{margin:0; font-size:1.05rem;}
    header .meta{font-size:0.95rem; opacity:0.95}
    .container{max-width:1100px; margin:18px auto; padding:0 16px;}
    .controls{display:flex; gap:8px; align-items:center; margin-bottom:12px; flex-wrap:wrap;}
    .controls input[type="search"], .controls select {
      padding:10px 12px; border-radius:10px; border:1px solid #e3e6ea; min-width:180px;
    }
    .controls button{background:var(--accent); color:#fff; border:none; padding:10px 12px; border-radius:10px; cursor:pointer;}
    .menu-grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
      gap:12px;
    }
    .card{
      background:var(--card); border-radius:var(--radius); overflow:hidden; box-shadow:0 6px 18px rgba(12,20,30,0.06);
      display:flex; flex-direction:column;
    }
    .thumb{width:100%; aspect-ratio:4/3; object-fit:cover; display:block; background:#eee;}
    .card-body{padding:12px; display:flex; flex-direction:column; gap:8px; flex:1;}
    .title{font-weight:600; font-size:1rem;}
    .cat{font-size:0.82rem; color:var(--muted);}
    .price-row{display:flex; align-items:center; justify-content:space-between; margin-top:auto;}
    .price{font-weight:700;}
    .add-btn{background:var(--accent); color:#fff; border:none; padding:8px 10px; border-radius:8px; cursor:pointer;}
    footer.cart-bar{
      position:fixed; left:16px; right:16px; bottom:16px; z-index:40; display:flex; justify-content:flex-end;
    }
    .cart{
      background:linear-gradient(180deg,#fff,#fafafa); padding:12px; border-radius:14px; box-shadow:0 8px 24px rgba(12,20,30,0.12); display:flex; gap:10px; align-items:center;
    }
    .cart button{padding:10px 12px; border-radius:10px; border:none; cursor:pointer;}
    .badge{background:#222; color:#fff; padding:6px 8px; border-radius:999px; font-weight:700;}
    .modal-backdrop{position:fixed; inset:0; background:rgba(0,0,0,0.45); display:none; align-items:center; justify-content:center; z-index:60;}
    .modal{background:#fff; width:min(800px,95%); border-radius:12px; padding:16px; max-height:85vh; overflow:auto;}
    table{width:100%; border-collapse:collapse;}
    th,td{padding:8px 6px; text-align:left; border-bottom:1px solid #eee;}
    .qty-btn{padding:6px 8px; border-radius:6px; border:1px solid #ddd; cursor:pointer; background:#fff;}
    .small{font-size:0.9rem; color:var(--muted);}
  </style>
</head>
<body>

  <header>
    <div>
      <h1>Vilasa International</h1>
      <div class="small">Scan QR and order — simple & free</div>
    </div>
    <div class="meta" id="table-info">Table: —</div>
  </header>

  <div class="container">
    <div class="controls">
      <input type="search" id="search" placeholder="Search items, e.g. paneer, biryani..." />
      <select id="categoryFilter">
        <option value="">All categories</option>
      </select>
      <button id="clearFilters">Clear</button>
      <div style="flex:1"></div>
      <div class="small">Items: <span id="count">0</span></div>
    </div>

    <div id="menu" class="menu-grid" aria-live="polite"></div>
  </div>

  <footer class="cart-bar">
    <div class="cart">
      <div style="display:flex;flex-direction:column;margin-right:12px;">
        <div style="font-weight:700">Cart</div>
        <div class="small" id="cartItemsSmall">0 items • ₹0</div>
      </div>
      <button id="viewCart" style="background:#fff;border:1px solid #ddd;margin-right:8px;">View Cart</button>
      <button id="checkout" style="background:var(--accent);color:#fff;">Checkout</button>
    </div>
  </footer>

  <div id="modalBackdrop" class="modal-backdrop">
    <div class="modal">
      <h3>Order Summary</h3>
      <div id="orderContent"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px;">
        <button id="closeModal" style="background:#fff;border:1px solid #ddd;padding:8px 10px;border-radius:8px;">Close</button>
        <button id="sendOrder" style="background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px;">Send Order</button>
      </div>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2">

/* ========= SUPABASE CONFIG ========= */
const SUPABASE_URL = "https://wlnyyvcukcyyjmdxjdji.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indsbnl5dmN1a2N5eWptZHhqZGppIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyMTc4MDksImV4cCI6MjA3OTc5MzgwOX0.mcbI2SpvJKwWjUqbX8xxz05MGrZvkdtqGJKd9ysSIEA";
const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ========= UTILITIES ========= */
const qs = s => document.querySelector(s);
const qsa = s => [...document.querySelectorAll(s)];
function escapeHtml(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;'); }

function getTableFromURL(){
  const p = new URLSearchParams(location.search);
  return p.get("table") || "Unknown";
}

/* ========= STATE ========= */
let MENU = [];
let filtered = [];
let cart = [];

/* ========= SUPABASE MENU FETCH ========= */
async function loadMenu() {
  const { data, error } = await db
    .from("menu")
    .select("*")
    .order("id");

  if (error) {
    console.error("Menu fetch error:", error);
    return [];
  }
  return data;
}

/* ========= RENDER ========= */
function renderCategories(){
  const cats = [...new Set(MENU.map(i => i.category))].sort();
  qs("#categoryFilter").innerHTML =
    `<option value="">All categories</option>` +
    cats.map(c => `<option>${escapeHtml(c)}</option>`).join("");
}

function renderMenu(list){
  const div = qs("#menu");
  div.innerHTML = "";
  qs("#count").textContent = list.length;

  if (!list.length){
    div.innerHTML = `<div style="grid-column:1/-1;padding:40px;text-align:center;color:var(--muted)">No items found</div>`;
    return;
  }

  list.forEach(item => {
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <img class="thumb" loading="lazy" src="${item.img}">
      <div class="card-body">
        <div class="title">${escapeHtml(item.name)}</div>
        <div class="cat small">${escapeHtml(item.category)}</div>
        <div class="price-row">
          <div class="price">₹${item.price}</div>
          <button class="add-btn" data-id="${item.id}">Add</button>
        </div>
      </div>
    `;
    div.appendChild(card);
  });

  qsa(".add-btn").forEach(btn => {
    btn.onclick = () => {
      const id = Number(btn.dataset.id);
      const item = MENU.find(m => m.id === id);
      addToCart(item);
      btn.textContent = "Added";
      setTimeout(() => btn.textContent = "Add", 700);
    };
  });
}

function applyFilters(){
  const q = qs("#search").value.toLowerCase();
  const c = qs("#categoryFilter").value;

  filtered = MENU.filter(it => {
    const catOK = c ? it.category === c : true;
    const searchOK = q ? it.name.toLowerCase().includes(q) : true;
    return catOK && searchOK;
  });

  renderMenu(filtered);
}

/* ======== CART ======== */
function addToCart(item){
  const ex = cart.find(c => c.id === item.id);
  if (ex) ex.qty++;
  else cart.push({ ...item, qty: 1 });
  updateCartUI();
}

function updateCartUI(){
  const total = cart.reduce((s,i)=>s+i.price*i.qty,0);
  const count = cart.reduce((s,i)=>s+i.qty,0);
  qs("#cartItemsSmall").textContent = `${count} items • ₹${total}`;
}

function showCartModal(){
  const modal = qs("#modalBackdrop");
  const content = qs("#orderContent");

  if (!cart.length){
    content.innerHTML = `<div style="padding:20px;color:#666">Cart is empty</div>`;
  } else {
    let html = `<table><thead><tr><th>Item</th><th>Price</th><th>Qty</th><th>Total</th></tr></thead><tbody>`;
    cart.forEach(c => {
      html += `
      <tr>
        <td>${escapeHtml(c.name)}</td>
        <td>₹${c.price}</td>
        <td>
          <button class="qty-btn" data-id="${c.id}" data-act="dec">-</button>
          ${c.qty}
          <button class="qty-btn" data-id="${c.id}" data-act="inc">+</button>
        </td>
        <td>₹${c.qty * c.price}</td>
      </tr>`;
    });
    html += `</tbody></table>`;
    content.innerHTML = html;

    qsa(".qty-btn").forEach(b => {
      b.onclick = () => {
        const item = cart.find(x => x.id == b.dataset.id);
        b.dataset.act === "inc" ? item.qty++ : item.qty--;
        cart = cart.filter(x => x.qty > 0);
        showCartModal();
        updateCartUI();
      };
    });
  }

  modal.style.display = "flex";
}

/* ========= ORDER BUILD ========= */
function buildOrderPayload(){
  return {
    table_no: getTableFromURL(),
    items: cart.map(c => ({ id: c.id, name: c.name, price: c.price, qty: c.qty })),
    total: cart.reduce((s,i)=>s+i.price*i.qty,0),
    created_at: new Date().toISOString()
  };
}

/* ========= SEND ORDER TO SUPABASE ========= */
async function sendOrder(){
  if (!cart.length) return alert("Cart is empty");

  const order = buildOrderPayload();

  const { error } = await db
    .from("orders")
    .insert([{
      table_no: order.table_no,
      items_json: order.items,
      total: order.total,
      created_at: order.created_at
    }]);

  if (error){
    console.error(error);
    return alert("Failed to place order");
  }

  alert("Order placed!");
  cart = [];
  updateCartUI();
  qs("#modalBackdrop").style.display = "none";
}

/* ========= INIT ========= */
async function init(){
  qs("#table-info").textContent = "Table: " + getTableFromURL();

  MENU = await loadMenu();
  renderCategories();
  applyFilters();

  qs("#search").oninput = applyFilters;
  qs("#categoryFilter").onchange = applyFilters;
  qs("#clearFilters").onclick = () => {
    qs("#search").value = "";
    qs("#categoryFilter").value = "";
    applyFilters();
  };

  qs("#viewCart").onclick = showCartModal;
  qs("#checkout").onclick = showCartModal;
  qs("#closeModal").onclick = () => qs("#modalBackdrop").style.display = "none";
  qs("#modalBackdrop").onclick = e => { if(e.target.id === "modalBackdrop") qs("#modalBackdrop").style.display = "none"; };
  qs("#sendOrder").onclick = sendOrder;

  updateCartUI();
}

init();
</script>

</body>
</html>
